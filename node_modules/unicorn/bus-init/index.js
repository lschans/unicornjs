/*
    This is the module that will do the bus initialize part
 */
/* Requiere modules*/
var redis = require("redis"),
    Promise = require('es6-promise').Promise;

/**
 * Handler the initiation of the service
 * @param config
 * @param name
 * @param oid
 */
exports.init = function (config, name, pid) {
    var redisClient = redis.createClient(config.redis.port, config.redis.server, {});
    // Listen to channel for requests
    redisClient.publish('broker-init', JSON.stringify({"service_name": name, "pid": process.pid, "channel": '', "ack": 0}));
};

/**
 * Listen to the broker channel until receive the channel where this service should be listening for jobs
 * @param config
 * @param name
 */
exports.listenBroker = function (config, name){

    return new Promise(function(resolve) {
        var initChannel = redis.createClient(config.redis.port, config.redis.server, {});
        // Catch redis errors
        initChannel.on("error", function (err) {
            console.log("Redis listen " + name + " error " + err);
        });
        // Catch redis message
        initChannel.on("message", function (channel, message) {
            /* Process incoming message and respond to response channel */
            /* listen to the new channel */
            var obj = JSON.parse(message);

            if (obj.service_name == name && obj.channel != '') {
                initChannel.unsubscribe();
                initChannel.end();
                //this.serviceChannel(config, obj.channel, name);
                resolve(obj.channel);
            }
        });

        initChannel.subscribe('broker-init');
    });
};

/**
 * Listen to the channel assigned by the broker and execute the method required
 * @param config
 * @param channel
 * @param name
 */
exports.serviceChannel = function (config, channel, name){
    var clientRedis = redis.createClient(config.redis.port, config.redis.server, {});
    var resposeRedis = redis.createClient(config.redis.port, config.redis.server, {});

    clientRedis.on('error', function (err) {
        console.log("Redis listen "+name+" error " + err);
    });

    clientRedis.on('message', function (channel, message) {
        //here comes the logic of module that is being execute
        console.log('Im the service and I have job to do!');
        var obj = JSON.parse(message);
        var result = 'Doing smt with this: '+(obj.data[0].value);
        var response =  {"result" : result, "ack": 0};
        //publish response in the channel of the service
        resposeRedis.publish(obj.channel, JSON.stringify(response));
    });

    clientRedis.subscribe(channel);
}