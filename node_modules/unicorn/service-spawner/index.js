var Spawn = require('child_process').spawn;
var activeServices = [];
module.exports = function(config, redis) {
    // Iterate over the list of services that need to start
    config.services.map(function(service) {
        config.process = service;
        for(var instanceCount=0; instanceCount < service.instances; instanceCount++) {
            //activeServices[service.name + '_' + instanceCount] = require('unicorn/redis-mthread')(config, redis);
            // Spawn service as a child process
            var instance = Spawn('node', ['index.js', '--spawn', instanceCount]);

            // Print data on the console when data comes in
            instance.stdout.on('data', function (data) {
                // Replace newlines, because data is a buffer and will print a newline for free
                console.log(data.toString().replace(/^\s+|\s+$/g, ''));
            });

            // Print errors on the console when errors comes in
            instance.stderr.on('data', function (data) {
                // Replace newlines, because data is a buffer and will print a newline for free
                console.log(data.toString().replace(/^\s+|\s+$/g, ''));
            });

            // Print info when a process exits
            instance.on('close', function (code) {
                console.log('child process exited with code ' + code);
            });

            activeServices.push({service:instance, name:service.name, pid:instance.pid});
        }
    });
};